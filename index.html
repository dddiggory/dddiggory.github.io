<!doctype html>
<html>
	<head>
		<title>Segment Sandbox & Project Space 6.0</title>

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

		<!-- UIKit 2-->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.27.5/css/uikit.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/2.27.5/js/uikit.min.js"></script>
		<!-- UIkit 3-->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/css/uikit.min.css" />
		<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/js/uikit.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/js/uikit-icons.min.js"></script>

		<!-- Favicon -->
		<link rel="icon" type="image/png" sizes="32x32" href="static/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="static/favicon-16x16.png">

		<link rel="stylesheet" href="static/style.css">


		<!-- start Segment -->
		<script>
		  !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"];analytics.factory=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e);analytics.push(t);return analytics}};for(var e=0;e<analytics.methods.length;e++){var t=analytics.methods[e];analytics[t]=analytics.factory(t)}analytics.load=function(e,t){var n=document.createElement("script");n.type="text/javascript";n.async=!0;n.src="https://cdn.segment.com/analytics.js/v1/"+e+"/analytics.min.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(n,a);analytics._loadOptions=t};analytics.SNIPPET_VERSION="4.1.0";
// 		  var sourceMiddlewareTest = function({payload, next, integrations}) {
// 		  	payload.obj.context.page["middleware-url"] = window.location.href+"&middlewaretest=true"
// 			payload.obj.properties["url"] = window.location.href+"&middlewaretest=true"
// 			next(payload)
// 		  };
// 		  analytics.addSourceMiddleware(sourceMiddlewareTest);
		var addContext = function({ payload, integration, next }) {
			const flattenObject = (obj, prefix = '') =>
			  Object.keys(obj).reduce((acc, k) => {
			    const pre = prefix.length ? prefix + '_' : '';
			    if (typeof obj[k] === 'object') Object.assign(acc, flattenObject(obj[k], pre + k));
			    else acc[pre + k] = obj[k];
			    return acc;
			  }, {});

			let flattenedContextObj = flattenObject(payload.obj.context)

			if (payload.obj.type == "identify") {
				payload.obj.traits = Object.assign(payload.obj.traits, flattenedContextObj)
				payload.obj.traits["Middleware Traits"] = true
			} else if ("properties" in payload.obj) {
				payload.obj.properties = Object.assign(payload.obj.properties, flattenedContextObj);
				payload.obj.properties["Middleware Props"] = true
			}
			next(payload);
		  }
		  analytics.addSourceMiddleware(addContext);
// 		  analytics.addDestinationMiddleware("Klaviyo", [addContext]);
// 		  analytics.addDestinationMiddleware("Mixpanel", [addContext]);
// 		  analytics.addDestinationMiddleware("Webhooks", [addContext]);
		  analytics.load("UvRi8XfjKk9SfkCSFfCwgQBhy70tyGct");
		  analytics.page();
		  }}();
		</script>		<!-- end Segment -->
		<script
		  data-workspace-id="eVgZgEcWSF"
		  data-source-id="i7kaHqOAfh"
		  src="https://unpkg.com/@segment/tracktor"
		> </script> <!-- tracktor script -->

	</head>

	<body>
		<section class="main">
			<div class="header uk-margin-top uk-text-bold">
				<img src="static/segment.png" alt="Segment Logo" /><br>
				Sandbox & Project Space (R7-2020)
			</div>

			<div class="grid-container uk-margin-medium-top">
				<div class="uk-panel uk-panel-box grid-item">
						<h3 class="uk-panel-title"><a href="https://github.com/dddiggory/segment-react-native-example">Countable Example</a></h3>
						<div class="uk-text-small card-body">
							<img src="static/countable.gif" width="25%" style="padding: 0 15px; float: left;"/>
							Segment onboarding project -- React Native app replicating <a href="https://countable.us">Countable.us</a> with realtime Segment tracking implemented.<br><br>
							Events are tracked in realtime using leoilab's <a href="https://github.com/leoilab/react-native-analytics-segment-io">React Native Wrapper</a> for Segment.
						</div>
						<div class="uk-text-meta card-footer">
							React Native
						</div>
				</div>
				<div class="uk-panel uk-panel-box grid-item ">
						<h3 class="uk-panel-title"><a href="https://github.com/dddiggory/segment-event-generator">Segment Event Generator</a></h3>
						<div class="uk-text-small card-body">
							<img src="static/event-generator.gif" width="60%" style="padding: 0 15px; float: left;"/>
							Quick attempt at a Segment event generator. Sends events to a specified write_key with randomization of: <strong>timestamps</strong> (in the last N days), <strong>event & property values</strong> (options to use a JSON file or inline values), <strong>names/emails/ages</strong> from uinames.com, and <strong>event frequencies</strong> per user.<br><br>
							This hasn't currently undergone any optimization and, at this stage, only creates about 25 users per minute. The version on the repo works with a 'bills.json' file reflecting a hypothetical <a href="https://countable.us">Countable</a> tracking plan.
						</div>
						<div class="uk-text-meta card-footer">
							Python
						</div>
				</div>
				<div class="uk-panel uk-panel-box grid-item">
						<h3 class="uk-panel-title"><a href="http://mpcohorts.com">MPCohorts.com</a></h3>
						<div class="uk-text-small card-body">
							(Legacy) self-service tool for creating custom cohorts in Mixpanel. Use a Mixpanel event-triggered notification to send your audiences to a webhook.
							<br><br>
							I'm leaving this online for posterity, but I'd strongly recommend <a href="https://segment.com/docs/personas/">Segment's Personas</a> to handle this (and many more use cases) today.
						</div>
						<div class="uk-text-meta card-footer">
							Flask, Webhooks, Mixpanel Profile API
						</div>
				</div>
				<!-- <div class="grid-item uk-panel uk-panel-box">
						<h3 class="uk-panel-title"><a href="/countable.html">Coming soon.</a></h3>
						Body text here.
				</div> -->
				
			</div>
			

			<div class="uk-margin-medium-top">
				<a class="uk-button uk-button-primary" href="https://segment.com">
				Go to Segment.com
				</a>
				<button class="uk-button uk-button-danger" id="event-sender" onclick="UIkit.notification({
						message: 'Event sent to Segment!', 
						status: 'success',
						pos: 'top-right',
						timeout: 1000})">
					Send an event
				</button>
				
				<button class="uk-button uk-button-default" id="id-violation">
					Generate violations
				</button>

				<button class="uk-button uk-button-secondary" id="id-reset">
					New anon ID
				</button>


				<form class='uk-form-width-small main'>
					<label class="uk-form-label">Select identity:</label>
					<select class="uk-select" id="id-select" onchange="UIkit.notification({
						message: 'Changed identity to '+$('#id-select')[0].value, 
						status: 'primary',
						pos: 'top-right',
						timeout: 1000})">
						<option>Diggory</option>
						<option>Ricky</option>
						<option>Prakash</option>
						<option>Sahil</option>
						<option>Jaimal</option>
						<option>Han</option>
					</select>
				</form>
			</div>
		
		</section>

		<div id="footer" style="position: absolute; bottom: 15; margin: auto; width: 100%; text-align: center;">
			Diggory Rycroft | diggory@segment.com
		</div>

		<script type="text/javascript">
			$( document ).ready(function(){
				analytics.debug();

				$("#event-sender").click(function(){
					analytics.track("Tap Button", {"Button ID": $(this)[0].id, "numbers_only": 12345});
				})

				$("#id-select").change(function(){
					var idString = $(this)[0].value;
					analytics.identify(idString);
					console.log("Identified as "+idString+".");
				})
				
				$("#id-reset").click(function(){
					analytics.reset();
					UIkit.notification({
						message: 'Identity is reset; New anonID is '+analytics.user().anonymousId(), 
						status: 'primary',
						pos: 'top-right',
						timeout: 1000});
				})
				
				$("#id-violation").click(function(){
					analytics.track("Bad Event", {"Button ID": $(this)[0].id});
					analytics.track("Tap Button", {"Button ID": $(this)[0].id, "numbers_only": "abcde"});
					analytics.track("Tap Button");
				})


			})
			

		</script>

	</body>


</html>
